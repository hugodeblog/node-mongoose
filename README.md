# Node.jsでMongooseからMongoDBを利用する


本サンプルではMongoDBを扱う時に良く利用されているMongooseというORMを使ってNode.jsからMongoDBのデータを扱うサンプルである。

https://www.npmjs.com/package/mongoose - Mongoose

## 実行手順

ローカルPC環境上でMongoDBが動いていて利用できることを前提としている。

まず最初に以下のファイルに定義されているデータを先にMongoDBに登録しておく。


```mealtypes.json
[
    {
        "_id": 1,
        "type": "朝食"
    },
    {
        "_id": 2,
        "type": "昼食"
    },
    {
        "_id": 3,
        "type": "夕食"
    }
]
```

このデータをMongoDBに登録するには

```txt
$ mongoimport -h localhost --db meal --collection mealtypes --drop --jsonArray --file mealtypes.json
```

この上で、

```txt
$ node mongoose-test.mjs 
Connected to database on Worker process: 67330
朝食に食べたのを検索します
------------------
[
  {
    "_id": "60069f5d7e898d0703f3a463",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a464",
        "menu": "目玉焼き"
      },
      {
        "_id": "60069f5d7e898d0703f3a465",
        "menu": "牛乳"
      },
      {
        "_id": "60069f5d7e898d0703f3a466",
        "menu": "トースト"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a46e",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a46f",
        "menu": "スクランブルエッグ"
      },
      {
        "_id": "60069f5d7e898d0703f3a470",
        "menu": "牛乳"
      },
      {
        "_id": "60069f5d7e898d0703f3a471",
        "menu": "トースト"
      }
    ],
    "__v": 0
  }
]
肉じゃががメニューに入っていたのを検索します
------------------
[
  {
    "_id": "60069f5d7e898d0703f3a46a",
    "type": {
      "_id": 3,
      "type": "夕食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a46b",
        "menu": "肉じゃが"
      },
      {
        "_id": "60069f5d7e898d0703f3a46c",
        "menu": "納豆"
      },
      {
        "_id": "60069f5d7e898d0703f3a46d",
        "menu": "味噌汁"
      }
    ],
    "__v": 0
  }
]
トーストがメニューに入っていたのを検索します
------------------
[
  {
    "_id": "60069f5d7e898d0703f3a463",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a464",
        "menu": "目玉焼き"
      },
      {
        "_id": "60069f5d7e898d0703f3a465",
        "menu": "牛乳"
      },
      {
        "_id": "60069f5d7e898d0703f3a466",
        "menu": "トースト"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a46e",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a46f",
        "menu": "スクランブルエッグ"
      },
      {
        "_id": "60069f5d7e898d0703f3a470",
        "menu": "牛乳"
      },
      {
        "_id": "60069f5d7e898d0703f3a471",
        "menu": "トースト"
      }
    ],
    "__v": 0
  }
]
牛乳 => オレンジジュースを入れ替えします
------------------
{
  "n": 2,
  "nModified": 2,
  "ok": 1
}
全コレクションをチェックします
------------------
[
  {
    "_id": "60069f5d7e898d0703f3a463",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a464",
        "menu": "目玉焼き"
      },
      {
        "_id": "60069f5d7e898d0703f3a465",
        "menu": "オレンジジュース"
      },
      {
        "_id": "60069f5d7e898d0703f3a466",
        "menu": "トースト"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a467",
    "type": {
      "_id": 2,
      "type": "昼食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a468",
        "menu": "ナポリタン"
      },
      {
        "_id": "60069f5d7e898d0703f3a469",
        "menu": "アイスコーヒー"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a46a",
    "type": {
      "_id": 3,
      "type": "夕食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a46b",
        "menu": "肉じゃが"
      },
      {
        "_id": "60069f5d7e898d0703f3a46c",
        "menu": "納豆"
      },
      {
        "_id": "60069f5d7e898d0703f3a46d",
        "menu": "味噌汁"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a46e",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a46f",
        "menu": "スクランブルエッグ"
      },
      {
        "_id": "60069f5d7e898d0703f3a470",
        "menu": "オレンジジュース"
      },
      {
        "_id": "60069f5d7e898d0703f3a471",
        "menu": "トースト"
      }
    ],
    "__v": 0
  }
]
夕食の全データを削除します
------------------
{
  "n": 1,
  "ok": 1,
  "deletedCount": 1
}
全コレクションをチェックします
------------------
[
  {
    "_id": "60069f5d7e898d0703f3a463",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a464",
        "menu": "目玉焼き"
      },
      {
        "_id": "60069f5d7e898d0703f3a465",
        "menu": "オレンジジュース"
      },
      {
        "_id": "60069f5d7e898d0703f3a466",
        "menu": "トースト"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a467",
    "type": {
      "_id": 2,
      "type": "昼食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a468",
        "menu": "ナポリタン"
      },
      {
        "_id": "60069f5d7e898d0703f3a469",
        "menu": "アイスコーヒー"
      }
    ],
    "__v": 0
  },
  {
    "_id": "60069f5d7e898d0703f3a46e",
    "type": {
      "_id": 1,
      "type": "朝食"
    },
    "foods": [
      {
        "_id": "60069f5d7e898d0703f3a46f",
        "menu": "スクランブルエッグ"
      },
      {
        "_id": "60069f5d7e898d0703f3a470",
        "menu": "オレンジジュース"
      },
      {
        "_id": "60069f5d7e898d0703f3a471",
        "menu": "トースト"
      }
    ],
    "__v": 0
  }
]
closeDB called
disconnected
connection closed
```
